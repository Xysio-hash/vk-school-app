<script>
        vkBridge.send('VKWebAppInit');

        // Функция проверки подписки на сообщества
        async function checkSubscriptions(userId) {
            try {
                // Проверка подписки на Colizeum (ID: 229200901)
                let colizeumCheck = { subscribed: false };
                let cyberCheck = { subscribed: false };
                
                try {
                    colizeumCheck = await vkBridge.send("VKWebAppCheckGroupSubscription", {
                        group_id: 229200901
                    });
                } catch (e) {
                    console.log("Ошибка проверки Colizeum (возможно AdBlock):", e);
                }
                
                try {
                    // Проверка подписки на CyberLeague (ID: 209470615)
                    cyberCheck = await vkBridge.send("VKWebAppCheckGroupSubscription", {
                        group_id: 209470615
                    });
                } catch (e) {
                    console.log("Ошибка проверки CyberLeague (возможно AdBlock):", e);
                }
                
                console.log("Результаты проверки:", { 
                    colizeum: colizeumCheck, 
                    cyber: cyberCheck 
                });
                
                return {
                    colizeum: colizeumCheck.subscribed,
                    cyber: cyberCheck.subscribed
                };
            } catch (error) {
                console.error("Ошибка проверки подписок:", error);
                // В случае ошибки возвращаем true, чтобы не блокировать пользователя
                return {
                    colizeum: true,
                    cyber: true
                };
            }
        }

        async function sendData() {
            const schoolSelect = document.getElementById("school");
            const gameSelect = document.getElementById("game");
            
            const school = schoolSelect.value;
            const schoolText = schoolSelect.selectedOptions[0].text;
            const game = gameSelect.value;
            const gameText = gameSelect.selectedOptions[0].text;
            
            // Проверка что выбраны школа и игра
            if (!school || !game) {
                alert("❌ Выберите школу и игру!");
                return;
            }
            
            const button = document.querySelector('.btn-submit');
            const originalText = button.innerHTML;
            
            try {
                // Показываем загрузку
                button.innerHTML = '<span class="loading"></span> Проверка...';
                button.disabled = true;
                
                // Получаем данные пользователя
                const user = await vkBridge.send('VKWebAppGetUserInfo');
                const phoneData = await vkBridge.send("VKWebAppGetPhoneNumber");
                
                // Проверяем подписки
                const subs = await checkSubscriptions(user.id);
                
                // Проверяем подписку на оба сообщества
                if (!subs || !subs.colizeum || !subs.cyber) {
                    let message = "❌ Для участия необходимо подписаться на:\n";
                    if (!subs?.colizeum) message += "• Colizeum: https://vk.com/colizeum_kolhoznaya\n";
                    if (!subs?.cyber) message += "• КиберЛига: https://vk.com/cyberleague67\n";
                    
                    alert(message);
                    
                    // Открываем ссылки для подписки
                    if (!subs?.colizeum) window.open("https://vk.com/colizeum_kolhoznaya");
                    if (!subs?.cyber) window.open("https://vk.com/cyberleague67");
                    
                    button.innerHTML = originalText;
                    button.disabled = false;
                    return;
                }
                
                // ✅ Если подписки есть - отправляем данные
                button.innerHTML = '<span class="loading"></span> Отправка...';
                
                const payload = {
                    vk_id: user.id,
                    name: `${user.first_name} ${user.last_name}`,
                    school_id: school,
                    school_name: schoolText,
                    game_id: game,
                    game_name: gameText,
                    phone: phoneData.phone_number,
                    date: new Date().toISOString()
                };
                
                console.log("Отправка данных:", payload);
                
                const response = await fetch("https://vk-school-app-server.onrender.com/save", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(payload)
                });
                
                const result = await response.json();
                console.log("Ответ сервера:", result);
                
                if (result.google) {
                    alert("✅ Готово! Твой выбор сохранён в Google таблицу. Спасибо за подписку и удачи в игре!");
                } else {
                    alert("✅ Готово! Твой выбор сохранён. Спасибо за подписку и удачи в игре!");
                }
                
            } catch (error) {
                alert("❌ Ошибка. Попробуй ещё раз или разреши доступ к телефону");
                console.error("Детали ошибки:", error);
            } finally {
                // Возвращаем кнопку в исходное состояние
                button.innerHTML = originalText;
                button.disabled = false;
            }
        }
    </script>
